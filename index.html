<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>حاسبة التداول المتقدمة</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: "Segoe UI", sans-serif; background: #0f172a; color: #fff; display:flex; justify-content:center; align-items:center; height:100vh; margin:0; direction:rtl;}
    .card {background:#1e293b; padding:25px; border-radius:20px; width:480px; box-shadow:0 8px 20px rgba(0,0,0,0.3);}
    h2 {text-align:center; margin-bottom:20px; color:#38bdf8;}
    label {display:block; margin:8px 0 5px;}
    input, select {width:100%; padding:10px; border:none; border-radius:10px; background:#334155; color:#fff; margin-bottom:10px;}
    button {width:100%; padding:12px; background:#38bdf8; border:none; border-radius:12px; color:#0f172a; font-weight:bold; cursor:pointer;}
    .results {display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;}
    .box {background:#0f172a; padding:12px; border-radius:12px; text-align:center; font-weight:bold;}
    .profit {color:#22c55e;} .loss {color:#ef4444;} .info {color:#38bdf8;}
    canvas {margin-top:20px; background:#0f172a; border-radius:12px; padding:10px;}
  </style>
</head>
<body>
  <div class="card">
    <h2>📊 حاسبة التداول المطورة</h2>

    <label>الهامش المبدئي (IMR %)</label>
    <input type="number" id="imr" placeholder="مثال: 2" oninput="updateLeverageOptions()">

    <label>هامش الحِفاظ (MMR %)</label>
    <input type="number" id="mmr" placeholder="مثال: 1" oninput="updateLeverageOptions()">

    <label id="leverageLabel" style="display: none;">الرافعة المالية المناسبة</label>
    <select id="leverageSelect" style="display: none;"></select>

    <label>المبلغ (USDT)</label>
    <input type="number" id="capital" placeholder="مثال: 10">

    <label>السعر الحالي</label>
    <input type="number" id="currentPrice" placeholder="مثال: 1.00">

    <label>سعر الهدف</label>
    <input type="number" id="targetPrice" placeholder="مثال: 1.05">

    <label>الاتجاه</label>
    <select id="direction">
      <option value="long">📈 شراء (Long)</option>
      <option value="short">📉 بيع (Short)</option>
    </select>

    <button onclick="calculate()">احسب</button>

    <div class="results">
      <div class="box info" id="marginDiff">فرق الهامش: -</div>
      <div class="box info" id="priceChangeBox">التغير: -</div>
      <div class="box profit" id="roiBox">ROI: -</div>
      <div class="box info" id="pnlBox">PnL: -</div>
      <div class="box loss" id="liqBox">التصفية: -</div>
    </div>

    <canvas id="chart" height="120"></canvas>
  </div>

  <script>
    let chart;
    
    function updateLeverageOptions() {
      let imr = parseFloat(document.getElementById("imr").value);
      let mmr = parseFloat(document.getElementById("mmr").value);
      
      let leverageSelect = document.getElementById("leverageSelect");
      let leverageLabel = document.getElementById("leverageLabel");
      leverageSelect.innerHTML = "";
      
      if (isNaN(imr) || isNaN(mmr) || imr <= mmr || imr <= 0) {
        leverageLabel.style.display = "none";
        leverageSelect.style.display = "none";
        return;
      }

      let marginDifference = imr - mmr;
      let maxLeverage = 100 / marginDifference;

      let leverageOptions = [];
      
      leverageOptions.push({ value: maxLeverage * 0.25, text: `${(maxLeverage * 0.25).toFixed(2)}x (مخاطر منخفضة)` });
      leverageOptions.push({ value: maxLeverage * 0.5, text: `${(maxLeverage * 0.5).toFixed(2)}x (مخاطر متوسطة)` });
      leverageOptions.push({ value: maxLeverage * 0.75, text: `${(maxLeverage * 0.75).toFixed(2)}x (مخاطر عالية)` });
      leverageOptions.push({ value: maxLeverage, text: `${maxLeverage.toFixed(2)}x (الرافعة القصوى - مخاطر عالية جداً)` });

      leverageOptions.forEach(option => {
        let opt = document.createElement("option");
        opt.value = option.value;
        opt.textContent = option.text;
        leverageSelect.appendChild(opt);
      });
      
      leverageLabel.style.display = "block";
      leverageSelect.style.display = "block";
    }

    function calculate() {
      let leverage = parseFloat(document.getElementById("leverageSelect").value);
      let imr = parseFloat(document.getElementById("imr").value);
      let mmr = parseFloat(document.getElementById("mmr").value);
      let capital = parseFloat(document.getElementById("capital").value);
      let currentPrice = parseFloat(document.getElementById("currentPrice").value);
      let targetPrice = parseFloat(document.getElementById("targetPrice").value);
      let direction = document.getElementById("direction").value;

      if (isNaN(leverage) || [imr, mmr, capital, currentPrice, targetPrice].some(isNaN) || imr <= mmr || imr <= 0) {
        alert("⚠️ رجاءً اختر الرافعة أولاً ثم أدخل كل القيم.");
        return;
      }
      
      let marginDiff = imr - mmr;
      let priceChange = ((targetPrice - currentPrice) / currentPrice) * 100;
      if (direction === "short") priceChange *= -1;
      let roiPercent = priceChange * leverage;
      let pnlValue = (capital * roiPercent) / 100;

      let liquidationPrice;
      if (direction === "long") {
        liquidationPrice = currentPrice * (1 - (marginDiff / 100));
      } else {
        liquidationPrice = currentPrice * (1 + (marginDiff / 100));
      }

      document.getElementById("marginDiff").innerHTML = `🛡️ فرق الهامش: ${marginDiff.toFixed(2)}%`;
      document.getElementById("priceChangeBox").innerHTML = `🔹 التغير: ${priceChange.toFixed(2)}%`;
      document.getElementById("roiBox").innerHTML = `💰 ROI: ${roiPercent.toFixed(2)}%`;
      document.getElementById("pnlBox").innerHTML = `📈 PnL: ${pnlValue.toFixed(2)} USDT`;
      document.getElementById("liqBox").innerHTML = `⚠️ التصفية: ${liquidationPrice.toFixed(4)}`;

      let ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: ["السعر الحالي", "الهدف", "التصفية"],
          datasets: [{
            label: "السعر",
            data: [currentPrice, targetPrice, liquidationPrice],
            borderColor: "#38bdf8",
            backgroundColor: "#38bdf8",
            tension: 0.2,
            fill: false
          }]
        },
        options: {plugins:{legend:{display:false}}, scales:{x:{ticks:{color:"#fff"}},y:{ticks:{color:"#fff"}}}}
      });
    }
  </script>
</body>
</html>
